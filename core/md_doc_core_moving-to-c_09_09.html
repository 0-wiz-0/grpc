<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>GRPC Core: Moving gRPC core to C++</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">GRPC Core
   &#160;<span id="projectnumber">5.0.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Moving gRPC core to C++ </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>October 2017</p>
<p>ctiller, markdroth, vjpai</p>
<h2>Background and Goal</h2>
<p>gRPC core was originally written in C89 for several reasons (possibility of kernel integration, ease of wrapping, compiler support, etc). Over time, this was changed to C99 as all relevant compilers in active use came to support C99 effectively. https://github.com/grpc/proposal/blob/master/L6-allow-c%2B%2B-in-grpc-core.md "Now, gRPC core is C++" (although the code is still idiomatically C code) with C linkage for public functions. Throughout all of these transitions, the public header files are committed to remain in C89.</p>
<p>The goal now is to make the gRPC core implementation true idiomatic C++ compatible with <a href="https://google.github.io/styleguide/cppguide.html">Google's C++ style guide</a>.</p>
<h2>Constraints</h2>
<ul>
<li>No use of standard library<ul>
<li>Standard library makes wrapping difficult/impossible and also reduces platform portability</li>
<li>This takes precedence over using C++ style guide</li>
</ul>
</li>
<li>But lambdas are ok</li>
<li>As are third-party libraries that meet our build requirements (such as many parts of abseil)</li>
<li>There will be some C++ features that don't work<ul>
<li><code>new</code> and <code>delete</code></li>
<li>pure virtual functions are not allowed because the message that prints out "Pure Virtual Function called" is part of the standard library<ul>
<li>Make a <code>#define GRPC_ABSTRACT {<a class="el" href="log_8h.html#a6ccf52ff690655cc22cd9d053650876f" title="abort() the process if x is zero, having written a line to the log. ">GPR_ASSERT(false)</a>;}</code> instead of <code>= 0;</code></li>
</ul>
</li>
</ul>
</li>
<li>The sanity for making sure that we don't depend on libstdc++ is that at least some tests should explicitly not include it<ul>
<li>Most tests can migrate to use gtest<ul>
<li>There are tremendous # of code paths that can now be exposed to unit tests because of the use of gtest and C++</li>
</ul>
</li>
<li>But at least some tests should not use gtest</li>
</ul>
</li>
</ul>
<h2>Roadmap</h2>
<ul>
<li>What should be the phases of getting code converted to idiomatic C++<ul>
<li>Opportunistically do leaf code that other parts don't depend on</li>
<li>Spend a little time deciding how to do non-leaf stuff that isn't central or polymorphic (e.g., timer, call combiner)</li>
<li>For big central or polymorphic interfaces, actually do an API review (for things like transport, filter API, endpoint, closure, exec_ctx, ...) .<ul>
<li>Core internal changes don't need a gRFC, but core surface changes do</li>
<li>But an API review should include at least a PR with the header change and tests to use it before it gets used more broadly</li>
</ul>
</li>
<li>iomgr polling for POSIX is a gray area whether it's a leaf or central</li>
</ul>
</li>
<li>What is the schedule?<ul>
<li>In Q4 2017, if some stuff happens opportunistically, great; otherwise ¯\_(ツ)_/¯</li>
<li>More updates as team time becomes available and committed to this project</li>
</ul>
</li>
</ul>
<h2>Implications for C++ API and wrapped languages</h2>
<ul>
<li>For C++ structs, switch to <code>using</code> when possible (e.g., Slice, ByteBuffer, ...)</li>
<li>The C++ API implementation might directly start using <code>grpc_transport_stream_op_batch</code> rather than the core surface <code><a class="el" href="structgrpc__op.html" title="Operation data: one field for each op type (except SEND_CLOSE_FROM_CLIENT which has no arguments) ...">grpc_op</a></code>.</li>
<li>Can we get wrapped languages to a point where we can statically link C++? This will take a year in probability but that would allow the use of <code>std::</code><ul>
<li>Are there other environments that don't support std library, like maybe Android NDK?<ul>
<li>Probably, that might push things out to 18 months </li>
</ul>
</li>
</ul>
</li>
</ul>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Fri Feb 2 2018 15:15:10 for GRPC Core by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
